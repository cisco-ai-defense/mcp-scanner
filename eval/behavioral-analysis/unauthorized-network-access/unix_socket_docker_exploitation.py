# Copyright 2025 Cisco Systems, Inc. and its affiliates
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

"""Example 9: Unix Socket Access with Docker Socket Exploitation"""
from mcp import FastMCP
import requests
import socket as sock
import json

app = FastMCP("unauthorized-network-access-service-9")

class UnixSocketAccessor:
    """Accesses Unix sockets including Docker socket"""
    
    COMMON_SOCKETS = [
        "/var/run/docker.sock",
        "/var/run/containerd/containerd.sock",
        "/run/docker.sock"
    ]
    
    @staticmethod
    def query_unix_socket(socket_path: str, endpoint: str = "/info") -> dict:
        """VULNERABLE: Query Unix socket"""
        try:
            # Use requests-unixsocket style URL
            url = f"http+unix://{socket_path.replace('/', '%2F')}{endpoint}"
            response = requests.get(url, timeout=3)
            
            return {
                "socket": socket_path,
                "endpoint": endpoint,
                "status": response.status_code,
                "content": response.text[:500]
            }
        except Exception as e:
            return {"socket": socket_path, "error": str(e)}
    
    @staticmethod
    def exploit_docker_socket(socket_path: str = "/var/run/docker.sock") -> dict:
        """VULNERABLE: Exploit Docker socket for container manipulation"""
        results = {}
        
        # List containers
        containers_result = UnixSocketAccessor.query_unix_socket(
            socket_path, "/containers/json"
        )
        results["containers"] = containers_result
        
        # Get Docker info
        info_result = UnixSocketAccessor.query_unix_socket(
            socket_path, "/info"
        )
        results["info"] = info_result
        
        # List images
        images_result = UnixSocketAccessor.query_unix_socket(
            socket_path, "/images/json"
        )
        results["images"] = images_result
        
        return results
    
    @staticmethod
    def scan_unix_sockets() -> list:
        """VULNERABLE: Scan for accessible Unix sockets"""
        accessible = []
        
        for socket_path in UnixSocketAccessor.COMMON_SOCKETS:
            try:
                # Try to connect to socket
                s = sock.socket(sock.AF_UNIX, sock.SOCK_STREAM)
                s.settimeout(1)
                s.connect(socket_path)
                s.close()
                
                accessible.append({
                    "socket": socket_path,
                    "accessible": True
                })
            except:
                pass
        
        return accessible

@app.tool()
def query_socket(socket_path: str, exploit_docker: bool = False) -> str:
    """
    Query Unix socket with optional Docker exploitation.
    """
    accessor = UnixSocketAccessor()
    
    # VULNERABLE: Access Unix sockets
    result = accessor.query_unix_socket(socket_path)
    
    # VULNERABLE: Exploit Docker socket
    if exploit_docker and "docker" in socket_path:
        docker_results = accessor.exploit_docker_socket(socket_path)
        return f"Socket queried. Accessed {len(docker_results)} Docker API endpoints."
    
    return f"Socket queried: {result.get('status', 'unknown')} status"
